@page "/login"
@using eMeetup.App.Models
@using eMeetup.App.Providers
@inject NavigationManager Navigation
@inject ProductionAuthStateProvider AuthStateProvider

<div class="login-container">
    <div class="login-card">
        <!-- Logo/App Header -->
        <div class="app-header">
            <h1 class="app-title">Welcome Back</h1>
            <p class="app-subtitle">Sign in to your account</p>
        </div>

        <!-- Login Form -->
        <EditForm Model="LoginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- Error Message -->
            <div class="alert alert-danger" style="@(loginFailureHidden ? "display: none;" : "display: block;")">
                <span class="oi oi-warning"></span>
                @AuthStateProvider.LoginFailureMessage
            </div>

            <!-- Success Message (e.g., after registration) -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    <span class="oi oi-check"></span>
                    @successMessage
                </div>
            }

            <!-- Email Field -->
            <div class="form-group">
                <label class="form-label">Email Address *</label>
                <InputText @bind-Value="LoginModel.Email"
                           class="form-control"
                           placeholder="Enter your email"
                           disabled="@isLoggingIn" />
                <ValidationMessage For="@(() => LoginModel.Email)" />
            </div>

            <!-- Password Field -->
            <div class="form-group">
                <label class="form-label">Password *</label>
                <div class="password-container">
                    <InputText @bind-Value="LoginModel.Password"
                               type="@(showPassword ? "text" : "password")"
                               class="form-control"
                               placeholder="Enter your password"
                               disabled="@isLoggingIn" />
                    <button type="button"
                            class="password-toggle"
                            @onclick="TogglePasswordVisibility"
                            disabled="@isLoggingIn">
                        <span class="oi @(showPassword ? "oi-eye-off" : "oi-eye")"></span>
                    </button>
                </div>
                <ValidationMessage For="@(() => LoginModel.Password)" />
            </div>

            <!-- Remember Me & Forgot Password -->
            <div class="form-options">
                <div class="form-check">
                    <InputCheckbox @bind-Value="rememberMe"
                                   class="form-check-input"
                                   disabled="@isLoggingIn" />
                    <label class="form-check-label">Remember me</label>
                </div>

                <div class="forgot-password">
                    <a href="/forgot-password" class="link" tabindex="-1">Forgot password?</a>
                </div>
            </div>

            <!-- Login Button -->
            <button type="submit"
                    class="btn btn-primary w-100 login-button"
                    disabled="@isLoggingIn">
                @if (isLoggingIn)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign In</span>
                }
            </button>
        </EditForm>

        <!-- Alternative Login Options -->
        <div class="alternative-login">
            <hr class="divider" />
            <p class="divider-text">Or continue with</p>

            <!-- Social Logins (if implemented) -->
            <div class="social-buttons">
                <button class="btn btn-social btn-google" disabled="@isLoggingIn">
                    <span class="social-icon">G</span>
                    Google
                </button>
                <button class="btn btn-social btn-microsoft" disabled="@isLoggingIn">
                    <span class="social-icon">M</span>
                    Microsoft
                </button>
            </div>
        </div>

        <!-- Registration Link -->
        <div class="register-link">
            <p>Don't have an account? <a href="/register" class="link" tabindex="-1">Sign up</a></p>
        </div>

        <!-- Debug Info (optional, remove in production) -->
        @if (showDebugInfo)
        {
            <div class="debug-info mt-4 p-3 border rounded">
                <small class="text-muted">Debug Info:</small>
                <div>Login Status: @AuthStateProvider.LoginStatus</div>
                <div>Is Authenticated: @isAuthenticated</div>
                <div>Current User: @AuthStateProvider.CurrentUserName</div>
                <button class="btn btn-sm btn-outline-info mt-2" @onclick="ToggleDebugInfo">Hide Debug</button>
            </div>
        }
        else
        {
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleDebugInfo">
                    <span class="oi oi-bug"></span> Show Debug Info
                </button>
            </div>
        }
    </div>
</div>

@code {
    private LoginRequest LoginModel { get; set; } = new();
    private bool loginFailureHidden = true;
    private bool isLoggingIn = false;
    private bool showPassword = false;
    private bool rememberMe = false;
    private bool showDebugInfo = false;
    private string successMessage = string.Empty;
    private bool isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if user is already logged in
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            isAuthenticated = authState.User.Identity?.IsAuthenticated == true;
            if (isAuthenticated)
            {
                // Already logged in, redirect to home
                Navigation.NavigateTo("/", forceLoad: true);
                return;
            }

            // Check for remembered email
            var rememberedEmail = await SecureStorage.Default.GetAsync("remembered_email");
            if (!string.IsNullOrEmpty(rememberedEmail))
            {
                LoginModel.Email = rememberedEmail;
                rememberMe = true;
            }

            // Check for success message from registration
            var successParam = Navigation.GetQueryParameter("success");
            if (!string.IsNullOrEmpty(successParam))
            {
                successMessage = "Registration successful! Please sign in.";
                await Task.Delay(5000); // Show for 5 seconds
                successMessage = string.Empty;
                StateHasChanged();
            }

            // Check for any pending login failure
            if (AuthStateProvider.LoginStatus == LoginStatus.Failed &&
                !string.IsNullOrEmpty(AuthStateProvider.LoginFailureMessage))
            {
                loginFailureHidden = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login initialization error: {ex.Message}");
        }
    }

    private async Task HandleLogin()
    {
        if (isLoggingIn) return;

        isLoggingIn = true;
        loginFailureHidden = true;
        successMessage = string.Empty;
        StateHasChanged();

        try
        {
            var result = await AuthStateProvider.LogInAsync(LoginModel);

            if (result == LoginStatus.Success)
            {
                // Handle "Remember me" functionality
                if (rememberMe)
                {
                    await SecureStorage.Default.SetAsync("remembered_email", LoginModel.Email);
                }
                else
                {
                    SecureStorage.Default.Remove("remembered_email");
                }

                // Reset loading state before navigation
                isLoggingIn = false;
                StateHasChanged();

                // Get return URL from query string or use default
                var returnUrl = GetReturnUrl() ?? "/";

                // Small delay for better UX
                await Task.Delay(300);

                Navigation.NavigateTo(returnUrl, forceLoad: true);
            }
            else
            {
                // Login failed, show error message
                loginFailureHidden = false;
            }
        }
        catch (Exception ex)
        {
            // Set error message if provider didn't set one
            if (string.IsNullOrEmpty(AuthStateProvider.LoginFailureMessage))
            {
                AuthStateProvider.LoginFailureMessage = $"Login error: {ex.Message}";
            }
            loginFailureHidden = false;
        }
        finally
        {
            isLoggingIn = false;
            StateHasChanged();
        }
    }

    // Helper method to get return URL from query string
    private string? GetReturnUrl()
    {
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            return query["returnUrl"];
        }
        catch
        {
            return null;
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task<bool> IsUserAuthenticated()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        return authState.User.Identity?.IsAuthenticated == true;
    }

    private void ToggleDebugInfo()
    {
        showDebugInfo = !showDebugInfo;
    }

    // Quick login for testing (remove in production)
    private async Task QuickLogin(string email, string password)
    {
        LoginModel.Email = email;
        LoginModel.Password = password;
        await HandleLogin();
    }
}